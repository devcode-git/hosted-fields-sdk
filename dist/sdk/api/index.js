"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.HostedFields=void 0;var merchantId,renderMode,fields,hostedfieldsurl,service,styles,_keys=require("babel-runtime/core-js/object/keys"),_keys2=_interopRequireDefault(_keys),_extends2=require("babel-runtime/helpers/extends"),_extends3=_interopRequireDefault(_extends2),_objectWithoutProperties2=require("babel-runtime/helpers/objectWithoutProperties"),_objectWithoutProperties3=_interopRequireDefault(_objectWithoutProperties2),_actions=require("./actions");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var el,callback,onLoadCallback,autoFocusNext,targets=[],responses=[],onLoadCounter=0,window=document.parentWindow||document.defaultView;function setup(e){merchantId=e.merchantId,renderMode=e.renderMode,hostedfieldsurl=e.hostedfieldsurl,fields=e.fields,service=e.service,styles=e.styles,callback=e.callback,onLoadCallback=e.onLoadCallback,autoFocusNext=e.autoFocusNext||!1,el=e.el,(renderMode&&"single"===renderMode?registerSingleIframe:registerIframes)()}function validateOrigin(e){return-1<[e,"https://test-hostedpages.paymentiq.io","https://hostedpages.paymentiq.io","https://card-fields.paymentiq.io"].indexOf(e)}function get(){targets.forEach(function(e){e.target.postMessage({action:_actions.actions.get,merchantId:merchantId,id:e.id},hostedfieldsurl)})}function reset(){targets=[]}function destroyContent(){targets=[],responses=[],onLoadCallback=callback=el=styles=service=hostedfieldsurl=fields=merchantId=null,onLoadCounter=0}function registerIframes(){targets=targets.concat(fields.map(function(e){return initIframe(e)}))}function registerSingleIframe(){targets=initSingleIframe()}function eventHandler(e){if(validateOrigin(e.origin))switch(e.data.action){case _actions.actions.formData:responses.push({id:e.data.id,data:e.data.formData}),sendCallback();break;case _actions.actions.formSubmit:get()}else console.error("Received message from invalid origin",e.origin)}function sendCallback(){var t,r=responses.map(function(e){return e.id}),e=targets.map(function(e){return e.id});r.length===e.length&&(t=!0,e.forEach(function(e){t=r.includes(e)}),t&&(e=responses.reduce(function(e,t){var r=e.errors,e=(0,_objectWithoutProperties3.default)(e,["errors"]),t=t.data,n=t.errors,t=(0,_objectWithoutProperties3.default)(t,["errors"]),e=(0,_extends3.default)({},e,t),t=(0,_extends3.default)({},r,n);return 0<(0,_keys2.default)(t).length&&(e.errors=t),e},{}),responses=[],callback()(e)))}function initIframe(e){var t=document.createElement("iframe"),r=(t.id="hosted-field-"+e.id,t.name="hosted-field-"+e.id,t.src=hostedfieldsurl+"?mid="+merchantId,document.querySelector(el)),n=document.createElement("div");n.id="hosted-field-container-"+e.id,n.className="hosted-field-container";try{n.appendChild(t),r.appendChild(n);var o=document.querySelector("#"+t.id).contentWindow;return t.onload=createIframeProxy.bind(this,e,o),{id:t.id,target:o}}catch(e){console.log(e),onLoadCallback()()}}function createIframeProxy(e,t){var r={};r[e.name]=e,window.addEventListener("message",eventHandler,!1),t.postMessage({action:_actions.actions.setupContent,styles:styles,fields:r,service:service},hostedfieldsurl),++onLoadCounter===fields.length&&onLoadCallback&&(onLoadCallback()(),onLoadCounter=0)}function initSingleIframe(){var e=document.createElement("iframe"),t=(e.id="hosted-field-single-iframe",e.name="hosted-field-single-iframe",e.src=hostedfieldsurl+"?mid="+merchantId,document.querySelector(el)),r=document.createElement("div");r.id="hosted-field-container-single-iframe",r.className="hosted-field-container";try{r.appendChild(e),t.appendChild(r);var n=document.querySelector("#hosted-field-single-iframe").contentWindow;return e.onload=createSingleIframeProxy.bind(this,fields,n),[{id:e.id,target:n}]}catch(e){console.log(e),onLoadCallback()()}}function createSingleIframeProxy(e,t){var r={};e.forEach(function(e){r[e.name]=e}),window.addEventListener("message",eventHandler,!1),t.postMessage({action:_actions.actions.setupSingleIframeContent,styles:styles,fields:r,service:service,settings:{autoFocusNext:autoFocusNext}},hostedfieldsurl),onLoadCallback()()}var HostedFields=exports.HostedFields={setup:setup,get:get,reset:reset};